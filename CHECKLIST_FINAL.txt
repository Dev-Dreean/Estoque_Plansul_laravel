ğŸ“‹ CHECKLIST FINAL - INTEGRAÃ‡ÃƒO POWER AUTOMATE

ğŸ¯ STATUS: âœ… PRONTO PARA PRODUÃ‡ÃƒO

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”§ O QUE FOI IMPLEMENTADO:

âœ… 1. Controller SolicitacaoEmailController
   - Valida token X-API-KEY
   - Parse de emails em HTML
   - Extrai dados de solicitaÃ§Ã£o
   - Cria registros no banco
   - Logs detalhados

âœ… 2. Middleware VerifyPowerAutomateToken
   - Valida header X-API-KEY
   - Usa hash_equals() para comparaÃ§Ã£o segura
   - Retorna 401 se token invÃ¡lido

âœ… 3. Migration add_email_fields_to_solicitacoes_bens
   - Coluna email_origem (200 chars)
   - Coluna email_assunto (200 chars)
   - Timestamps automÃ¡ticos
   - Executada com sucesso no KingHost âœ…

âœ… 4. Config solicitacoes_bens.php
   - LÃª variÃ¡veis de .env
   - Token obrigatÃ³rio
   - Email obrigatÃ³rio

âœ… 5. Parser HTML Melhorado
   - Converte <br> em quebras de linha
   - Remove tags HTML mantendo conteÃºdo
   - Normaliza espaÃ§os em branco
   - Extrai: solicitante, matricula, projeto, UF, setor, local, observaÃ§Ã£o
   - Parse de itens com formato: "descricao; quantidade; unidade; complemento"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸš€ COMO TESTAR AGORA:

OPÃ‡ÃƒO 1: Power Automate Flow (Recomendado)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Abra o Power Automate Flow que foi criado
2. Envie um email para o Outlook com este template:

---
Solicitante: JoÃ£o Silva Teste
Matricula: 99999
Projeto: 1234 - Sistema Plansul
UF: SP
Setor: TI
Local destino: Sala de Testes
Observacao: Email de teste do sistema

Itens:
- Monitor 24"; 1; UN; Teste monitor
- Mouse; 1; UN; Teste mouse
---

3. O Power Automate vai executar automaticamente
4. A solicitaÃ§Ã£o deve aparecer em: https://plansul.info/solicitacoes

OPÃ‡ÃƒO 2: Teste via cURL (Debug)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Execute no terminal (bash/PowerShell com curl):

curl -X POST https://plansul.info/api/solicitacoes/email \
  -H "Content-Type: application/json" \
  -H "X-API-KEY: f8a2c5e9d3b7f1a6e8c2f5b9d3e7a1c4f6b9d2e5f7a0c3e6f9b2d5e8a1c4f7" \
  -d '{
    "from": "seu_email@empresa.com",
    "subject": "Solicitacao de Bem",
    "body": "Solicitante: JoÃ£o Silva\nMatricula: 12345\nProjeto: 1234 - Sistema Plansul\nUF: SC\nSetor: Compras\nLocal destino: Almoxarifado Central\nObservacao: Teste\n\nItens:\n- Monitor 24; 1; UN; Teste"
  }'

Resposta esperada (200 OK):
{
  "success": true,
  "message": "Solicitacao registrada com sucesso.",
  "solicitacao_id": 123
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ” COMO VERIFICAR SE FUNCIONOU:

1. Dashboard Plansul
   - Acesse: https://plansul.info/solicitacoes
   - Procure pela solicitaÃ§Ã£o mais recente
   - Verifique se os itens aparecem

2. Logs do Servidor
   ssh plansul@ftp.plansul.info "tail -30 ~/www/estoque-laravel/storage/logs/laravel.log"

3. Banco de Dados (SQL)
   SELECT * FROM solicitacoes_bens ORDER BY created_at DESC LIMIT 1;
   SELECT * FROM solicitacoes_bens_itens 
   WHERE solicitacao_bem_id = (SELECT MAX(id) FROM solicitacoes_bens);

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âš™ï¸ CONFIGURAÃ‡Ã•ES ATIVAS:

KingHost (.env):
  âœ… POWER_AUTOMATE_TOKEN = f8a2c5e9d3b7f1a6e8c2f5b9d3e7a1c4f6b9d2e5f7a0c3e6f9b2d5e8a1c4f7
  âœ… SOLICITACOES_BENS_EMAIL_TO = seu_email@empresa.com
  âœ… APP_ENV = production
  âœ… APP_DEBUG = false (modo seguro)

Rota:
  âœ… POST /api/solicitacoes/email
  âœ… Middleware: VerifyPowerAutomateToken

Migration:
  âœ… 2026_01_26_120000_add_email_fields_to_solicitacoes_bens [Ran]

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ CAMPOS OBRIGATÃ“RIOS:

Para a solicitaÃ§Ã£o ser criada, o email PRECISA ter:

âœ… Solicitante (nome) - extrado do email ou do usuÃ¡rio logado
âœ… Projeto - formato "9999 - Nome do Projeto" (serÃ¡ buscado em tabfant)
âœ… Local destino - deve existir em locais_projeto
âœ… Itens - pelo menos 1 item no formato "descricao; qtd; unidade; complemento"

Se algum campo faltar, o sistema retorna 422 com erro detalhado.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸš¨ POSSÃVEIS ERROS E SOLUÃ‡Ã•ES:

Erro 401 (Unauthorized)
â†’ Token nÃ£o confere
â†’ SoluÃ§Ã£o: Verificar se X-API-KEY no Power Automate Ã© exatamente igual
           ao POWER_AUTOMATE_TOKEN no .env do KingHost

Erro 422 (Unprocessable Entity)
â†’ Campo obrigatÃ³rio faltando
â†’ SoluÃ§Ã£o: Verificar no response qual campo estÃ¡ faltando
           Ajustar template do email

Erro 500 (Internal Server Error)
â†’ Erro interno do servidor
â†’ SoluÃ§Ã£o: Verificar logs do KingHost
           SSH: tail -50 ~/www/estoque-laravel/storage/logs/laravel.log

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… CONCLUSÃƒO:

Tudo estÃ¡ pronto para funcionar 100%!

PrÃ³ximo passo: Envie um email usando o template acima para testar.

Se tudo funcionou:
1. SolicitaÃ§Ã£o aparece em https://plansul.info/solicitacoes âœ…
2. Itens aparecem corretamente âœ…
3. Email de origem Ã© gravado na tabela âœ…
4. Sistema estÃ¡ 100% funcional ğŸ‰

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Data: 26/01/2026
Commits: 
  - 7aaa6ed: IntegraÃ§Ã£o Power Automate (inicial)
  - 83ed6aa: Suporte a HTML (corrigido)
  - 12086d0: DocumentaÃ§Ã£o e testes

Status: ğŸŸ¢ PRODUÃ‡ÃƒO PRONTO
