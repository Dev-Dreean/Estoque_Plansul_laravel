================================================================================
DOCUMENTA√á√ÉO: SINCRONIZA√á√ÉO DE FUNCION√ÅRIOS E PROJETOS PARA KINGHOST
================================================================================

OBJETIVO
--------
Sincronizar dados de funcion√°rios (tabela 'funcionarios') e projetos (tabela 'tabfant')
do banco local (cadastros_plansul) para o servidor KingHost (mysql.plansul2.kinghost.net).

TABELAS SINCRONIZADAS
---------------------

1. FUNCION√ÅRIOS
   - Tabela Local: funcionarios
   - Banco KingHost: plansul104
   - Host: mysql.plansul2.kinghost.net:3306
   - Colunas Sincronizadas:
     * CDMATRFUNCIONARIO (chave prim√°ria, string)
     * NMFUNCIONARIO (nome do funcion√°rio)
     * DTADMISSAO (data de admiss√£o)
     * CDCARGO (c√≥digo do cargo)
     * CODFIL (c√≥digo da filial)
     * UFPROJ (unidade federativa do projeto)

2. PROJETOS (TABFANT)
   - Tabela Local: tabfant
   - Banco KingHost: plansul263
   - Host: mysql.plansul2.kinghost.net:3306
   - Colunas Sincronizadas:
     * id (chave prim√°ria, inteiro)
     * NOMEPROJETO (nome do projeto)
     * CDPROJETO (c√≥digo do projeto)
     * LOCAL (local/endere√ßo do projeto)
     * UF (unidade federativa)

CONFIGURA√á√ÉO PR√âVIA
-------------------

Certifique-se de que o arquivo .env cont√©m:

  # Banco Local (autom√°tico)
  DB_CONNECTION=mysql
  DB_HOST=127.0.0.1
  DB_PORT=3306
  DB_DATABASE=cadastros_plansul
  DB_USERNAME=root
  DB_PASSWORD=

  # KingHost - Funcion√°rios (REQUERIDO)
  FUNCIONARIOS_SOURCE_HOST=mysql.plansul2.kinghost.net
  FUNCIONARIOS_SOURCE_PORT=3306
  FUNCIONARIOS_SOURCE_USER=plansul104
  FUNCIONARIOS_SOURCE_PASS=plansul104
  FUNCIONARIOS_SOURCE_DB=plansul104

  # KingHost - Tabfantasia (REQUERIDO)
  TABFANTASIA_SOURCE_HOST=mysql.plansul2.kinghost.net
  TABFANTASIA_SOURCE_PORT=3306
  TABFANTASIA_SOURCE_USER=plansul263
  TABFANTASIA_SOURCE_PASS=plansul263
  TABFANTASIA_SOURCE_DB=plansul263

Como Usar
---------

SINTAXE GERAL:
  C:\> php scripts/sincronizar_funcionarios_projetos_kinghost.php [op√ß√µes]

OP√á√ïES:
  (nenhum)           ‚Üí Sincronizar TUDO
  --dry-run          ‚Üí Simular sincroniza√ß√£o SEM fazer altera√ß√µes
  --log-path=PATH    ‚Üí Usar caminho customizado para log (padr√£o: storage/logs/)

EXEMPLOS:
  1) Sincronizar TUDO:
     C:\> php scripts/sincronizar_funcionarios_projetos_kinghost.php

  2) Simular antes de executar (DRY-RUN):
     C:\> php scripts/sincronizar_funcionarios_projetos_kinghost.php --dry-run

  3) Sincronizar com log customizado:
     C:\> php scripts/sincronizar_funcionarios_projetos_kinghost.php --log-path=storage/logs/meu_sync.log

  4) Combinado:
     C:\> php scripts/sincronizar_funcionarios_projetos_kinghost.php --dry-run --log-path=storage/logs/teste.log

FLUXO DA SINCRONIZA√á√ÉO
----------------------

O script executa os seguintes passos:

1Ô∏è‚É£  CONEX√ÉO
   ‚úì Conecta ao banco local (cadastros_plansul)
   ‚úì Conecta ao KingHost (plansul104 - funcion√°rios)
   ‚úì Conecta ao KingHost (plansul263 - projetos)

2Ô∏è‚É£  SINCRONIZAR FUNCION√ÅRIOS
   ‚úì Busca todos os funcion√°rios do banco local
   ‚úì Para cada funcion√°rio:
      - Verifica se J√Å existe no KingHost
      - Se existe ‚Üí UPDATE (atualizar campos)
      - Se n√£o existe ‚Üí INSERT (adicionar novo)
   ‚úì Registra: adicionados, atualizados, erros

3Ô∏è‚É£  SINCRONIZAR PROJETOS
   ‚úì Busca todos os projetos do banco local
   ‚úì Para cada projeto:
      - Verifica se J√Å existe no KingHost
      - Se existe ‚Üí UPDATE (atualizar campos)
      - Se n√£o existe ‚Üí INSERT (adicionar novo)
   ‚úì Registra: adicionados, atualizados, erros

4Ô∏è‚É£  VALIDA√á√ÉO
   ‚úì Compara quantidade de registros:
      - Funcion√°rios: banco local vs KingHost
      - Projetos: banco local vs KingHost
   ‚úì Valida se contagens batem (‚úÖ OK ou ‚ö†Ô∏è DIFEREN√áA)

5Ô∏è‚É£  LOG
   ‚úì Gera arquivo de log em: storage/logs/sincronizacao_YYYY-MM-DD_HHMM.log
   ‚úì Cont√©m todos os passos, erros e valida√ß√µes

INTERPRETANDO O LOG
------------------

LOG NORMAL (SUCESSO):
  [2025-02-05 14:30:45] INFO: Conectado ao banco local: cadastros_plansul
  [2025-02-05 14:30:45] INFO: ‚úÖ Conectado ao KingHost (Funcion√°rios)
  [2025-02-05 14:30:45] INFO: ‚úÖ Conectado ao KingHost (Projetos)
  [2025-02-05 14:30:46] INFO: Encontrados 5227 funcion√°rios locais
  [2025-02-05 14:30:50] INFO: ‚úÖ Adicionados: 0, Atualizados: 5227, Erros: 0, Ignorados: 0
  [2025-02-05 14:30:50] INFO: Encontrados 877 projetos locais
  [2025-02-05 14:30:52] INFO: ‚úÖ Adicionados: 5, Atualizados: 872, Erros: 0, Ignorados: 0
  [2025-02-05 14:30:52] INFO: üìä FUNCION√ÅRIOS: Local=5227 vs KingHost=5227 [‚úÖ OK]
  [2025-02-05 14:30:52] INFO: üìä PROJETOS: Local=877 vs KingHost=877 [‚úÖ OK]
  [2025-02-05 14:30:52] SUCESSO: ‚úÖ SINCRONIZA√á√ÉO CONCLU√çDA

ERROS COMUNS
------------

‚ùå "Erro ao conectar banco local: SQLSTATE[HY000]: General error"
   ‚Üí Verifique se MySQL local est√° rodando
   ‚Üí Comando: mysql -u root (no PowerShell)

‚ùå "Erro ao conectar KingHost (Funcion√°rios): SQLSTATE[HY000]"
   ‚Üí Verifique .env: FUNCIONARIOS_SOURCE_*
   ‚Üí Verifique conex√£o de internet (SSH/acesso remoto)
   ‚Üí Teste com: ping mysql.plansul2.kinghost.net

‚ùå "Erro ao conectar KingHost (Tabfantasia): SQLSTATE[HY000]"
   ‚Üí Verifique .env: TABFANTASIA_SOURCE_*
   ‚Üí Mesmo teste acima

‚ùå "Erro ao sincronizar funcion√°rio ABC123: Unknown column 'CDMATRFUNCIONARIO'"
   ‚Üí A coluna pode ter nome diferente no KingHost
   ‚Üí Verifique estrutura com: DESCRIBE funcionarios;

‚ö†Ô∏è  "‚ö†Ô∏è Encontrados X funcion√°rios locais vs Y KingHost [‚ö†Ô∏è DIFEREN√áA]"
   ‚Üí H√° discrep√¢ncia ap√≥s sincroniza√ß√£o
   ‚Üí Verifique log para erros durante inserts
   ‚Üí Poss√≠vel: registro sem chave prim√°ria, ou erro de tipo de dado

Como Usar (PASSO A PASSO)
--------------------------

1) PREPARAR:
   a) Certifique-se que MySQL local est√° rodando
   b) Verifique .env cont√©m credenciais KingHost
   c) Fa√ßa BACKUP: php artisan backup:database

2) TESTE INICIAL (DRY-RUN):
   C:\> php scripts/sincronizar_funcionarios_projetos_kinghost.php --dry-run
   
   ‚úì Leia o log em storage/logs/sincronizacao_YYYY-MM-DD_HHMM.log
   ‚úì Verifique se h√° erros

3) EXECUTAR PRODU√á√ÉO:
   C:\> php scripts/sincronizar_funcionarios_projetos_kinghost.php
   
   ‚úì Aguarde conclus√£o (pode levar 30-60 segundos)
   ‚úì Verifique linha final: "‚úÖ SINCRONIZA√á√ÉO CONCLU√çDA"

4) VALIDAR RESULTADO:
   ‚úì Log mostrar√° contagens antes/depois
   ‚úì Procure por "‚úÖ OK" na se√ß√£o FUNCION√ÅRIOS e PROJETOS
   ‚úì Se houver ‚ö†Ô∏è DIFEREN√áA, investigue erros no log

5) PR√ìXIMAS EXECUTA√á√ïES:
   ‚úì Repita do passo 2
   ‚úì Sempre usar --dry-run antes para produ√ß√£o

RESTAURAR DE BACKUP
-------------------

Se algo deu errado no KingHost e voc√™ precisa re-sincronizar:

1) Verifique backup local foi criado: storage/backups/
2) O script s√≥ faz UPSERT (insert or update), n√£o deleta nada
3) Para for√ßar uma sincroniza√ß√£o completa:
   a) Conecte ao KingHost (SSH ou phpMyAdmin)
   b) Limpe a tabela: TRUNCATE TABLE funcionarios;
   c) Limpe a tabela: TRUNCATE TABLE tabfant;
   d) Execute o script novamente

FREQU√äNCIA RECOMENDADA
----------------------

- DESENVOLVIMENTO: Sempre que adicionar/editar funcion√°rios/projetos localmente
- PRODU√á√ÉO: Mensalmente ou quando solicitado pelo gestor
- EMERG√äNCIA: Imediatamente ap√≥s altera√ß√µes em massa / reparos

CONTATO / SUPORTE
-----------------

Se encontrar problemas:
1) Verifique .env est√° correto
2) Leia o arquivo de log completo
3) Procure por "ERRO" ou "‚ùå" no log
4) Contate o desenvolvedor com o arquivo de log

HIST√ìRICO DE SINCRONIZA√á√ïES
----------------------------

Todos os logs est√£o em: storage/logs/sincronizacao_*.log

Exemplo de log hist√≥rico:
  storage/logs/sincronizacao_2025-02-05_143045.log
  storage/logs/sincronizacao_2025-02-04_100230.log
  storage/logs/sincronizacao_2025-02-03_154800.log

================================================================================
√öltima atualiza√ß√£o: 2025-02-05
Autor: Copilot / AI Agent
================================================================================
