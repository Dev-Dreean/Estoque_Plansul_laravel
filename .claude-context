# üîê CONTEXTO DE REFER√äNCIA - SISTEMA DE PERMISS√ïES

## ‚ö° VERIFICA√á√ÉO R√ÅPIDA ANTES DE QUALQUER MUDAN√áA

**Toda vez que for fazer mudan√ßa, verificar:**

1. ‚úÖ **Precisa de acesso restrito?** ‚Üí Verificar `NIVEL_VISIBILIDADE` e `acessousuario`
2. ‚úÖ **Qual perfil pode fazer?** ‚Üí USR, ADM, ou SUP?
3. ‚úÖ **Precisa de Policy?** ‚Üí `$this->authorize('action', $model)`
4. ‚úÖ **Precisa de Middleware?** ‚Üí `tela.access:NNNN` ou `admin`

---

## üé≠ HIERARQUIA DE PERFIS

```
SUPER ADMIN (SUP)
‚îú‚îÄ isGod() = true
‚îú‚îÄ isAdmin() = true
‚îú‚îÄ podeExcluir() = true
‚îú‚îÄ V√™ TODAS as telas
‚îî‚îÄ GOD MODE - sem restri√ß√µes

ADMIN (ADM)
‚îú‚îÄ isGod() = false
‚îú‚îÄ isAdmin() = true
‚îú‚îÄ podeExcluir() = false
‚îú‚îÄ V√™ telas TODOS + ADM
‚îî‚îÄ Acesso autom√°tico

USU√ÅRIO (USR)
‚îú‚îÄ isGod() = false
‚îú‚îÄ isAdmin() = false
‚îú‚îÄ podeExcluir() = false
‚îú‚îÄ V√™ apenas telas TODOS
‚îî‚îÄ Precisa de acessousuario
```

---

## üìã TABELAS CR√çTICAS

### `usuario` (Banco de dados)
- Coluna: `PERFIL` ‚Üí 'USR', 'ADM', ou 'SUP'
- Model: `App\Models\User`
- M√©todos: `isGod()`, `isAdmin()`, `isSuperAdmin()`, `podeExcluir()`

### `acessotela` (Banco de dados)
- Coluna: `NIVEL_VISIBILIDADE` ‚Üí 'TODOS', 'ADM', ou 'SUP'
- Define quem v√™ cada tela
- NUSEQTELA = ID da tela

### `acessousuario` (Banco de dados)
- Chave: (NUSEQTELA, CDMATRFUNCIONARIO)
- Coluna: `INACESSO` ‚Üí 'S' ou 'N'
- D√° permiss√£o EXPL√çCITA para Usu√°rios comuns (USR)

---

## üõ£Ô∏è MIDDLEWARE DISPON√çVEL

| Middleware | Acesso | Uso |
|---|---|---|
| `admin` | ADM, SUP | Apenas administradores |
| `tela.access:NNNN` | ADM, SUP, ou USR com perm | Controle granular por tela |
| `auth` | Qualquer logado | Autentica√ß√£o apenas |

---

## üîÑ FLUXO DE VERIFICA√á√ÉO (4 ETAPAS)

```
1. Autenticado? (middleware: auth)
   ‚Üì
2. Tela vis√≠vel? (telaVisivel)
   ‚Üì
3. Tem acesso √† tela? (temAcessoTela)
   ‚Üì
4. Pode fazer a√ß√£o? (Policy/authorize)
```

---

## üìç LOCALIZA√á√ÉO DOS ARQUIVOS PRINCIPAIS

### Modelos
- `app/Models/User.php` ‚Üê M√©todos de permiss√£o
- `app/Models/AcessoUsuario.php` ‚Üê Rela√ß√£o tela-usu√°rio

### Middleware
- `app/Http/Middleware/CheckTelaAccess.php` ‚Üê Verifica `tela.access:NNNN`
- `app/Http/Middleware/AdminMiddleware.php` ‚Üê Verifica `admin`

### Policies
- `app/Policies/PatrimonioPolicy.php` ‚Üê Autoriza√ß√£o por a√ß√£o

### Routes
- `routes/web.php` ‚Üê Middleware das rotas

### Views
- `resources/views/patrimonios/atribuir.blade.php` ‚Üê Exibe tela com bot√£o "Baixar"

---

## üö® CASOS CR√çTICOS

### ‚ùå ERRO: Bot√£o n√£o aparece para Usu√°rio
**Verificar:**
1. Tela tem `NIVEL_VISIBILIDADE = 'TODOS'`?
2. Usu√°rio tem registro em `acessousuario` com `INACESSO = 'S'`?
3. Rota tem middleware `tela.access:NNNN`?

### ‚ùå ERRO: Usu√°rio n√£o consegue deletar
**Verificar:**
1. `podeExcluir()` = true? (apenas SUP)
2. Policy permite `delete`?

### ‚ùå ERRO: Admin v√™ tela que n√£o deveria
**Verificar:**
1. `NIVEL_VISIBILIDADE` est√° correto?
2. Rota tem middleware correto?

---

## ‚úÖ CHECKLIST ANTES DE LIBERAR ACESSO

- [ ] Defini quem pode acessar? (USR, ADM, SUP)
- [ ] Criei entrada em `acessotela` com `NIVEL_VISIBILIDADE` correto?
- [ ] Se Usu√°rio comum precisa, criei `acessousuario`?
- [ ] Usei middleware correto na rota?
- [ ] Testei com os 3 perfis?
- [ ] N√£o quebrei permiss√µes existentes?

---

## üéØ PADR√ïES COMUNS

### Liberar para APENAS Super Admin
```php
Route::get('/path', [Controller::class, 'action'])
    ->middleware('admin')  // ‚Üê Aceita ADM e SUP
```

### Liberar para Super Admin, Admin, ou Usu√°rios com Perm
```php
Route::post('/path', [Controller::class, 'action'])
    ->middleware('tela.access:1000')  // ‚Üê Verifica permiss√£o
```

### Mostrar Bot√£o na View
```blade
@if(Auth::user()->temAcessoTela(1000))
    <!-- Mostrar bot√£o -->
@endif
```

---

## üìå TELAS EXISTENTES

| NUSEQTELA | Descri√ß√£o | NIVEL_VISIBILIDADE |
|---|---|---|
| 1000 | Patrim√¥nios | TODOS |
| 1001 | Dashboard | TODOS |
| 1002 | Usu√°rios | ADM |
| 1003 | Telas | SUP |

---

**√öltima Atualiza√ß√£o**: 3 de novembro de 2025  
**Vers√£o**: 1.0  
**Status**: ‚úÖ Ativo e Atualizado
