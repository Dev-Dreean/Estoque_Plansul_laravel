==================================================================================
DOCUMENTO: SYNC_KINGHOST_AUTO.txt
PROPÃ“SITO: InstruÃ§Ãµes automÃ¡ticas para sincronizar plansul263 + plansul104
DATA DE CRIAÃ‡ÃƒO: 2026-02-05
ATUALIZADO PELA IA: Sim (para futuras referÃªncias - copilot usarÃ¡ este arquivo)
==================================================================================

RESUMO EXECUTIVO:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Sincronizar dados de TWO bancos MySQL remotos para o KingHost:
  â€¢ plansul263 (banco de PROJETOS) â†’ tabfant
  â€¢ plansul104 (banco de FUNCIONÃRIOS) â†’ funcionarios

Tudo via SSH (sem necessidade de explicaÃ§Ã£o manual a cada vez).

==================================================================================
PARTE 1: ACESSO REMOTO E CREDENCIAIS
==================================================================================

SERVIDOR SSH (KingHost):
  Host: ftp.plansul.info
  User: plansul
  Path: ~/www/estoque-laravel

BANCOS REMOTOS (Direct MySQL):
  Servidor: mysql.plansul2.kinghost.net
  
  1. plansul263 (Projetos):
     User: plansul263
     Pass: plansul263
     Banco: plansul263
     Tabela: tabfant
  
  2. plansul104 (FuncionÃ¡rios):
     User: plansul104
     Pass: plansul104
     Banco: plansul104
     Tabela: funcionarios

KINGHOST DESTINO (ProduÃ§Ã£o):
  Host: mysql07-farm10.kinghost.net
  User: plansul004_add2
  Pass: A33673170a
  Banco: plansul04
  Tabelas destino: tabfant, funcionarios

BANCO LOCAL (Desenvolvimento):
  Host: 127.0.0.1
  User: root
  Banco: cadastros_plansul
  (Definido em .env)

==================================================================================
PARTE 2: SCRIPT PRINCIPAL
==================================================================================

ARQUIVO: scripts/sync_kinghost_full_plansul263_104.php

DESCRIÃ‡ÃƒO:
  Script unificado que sincroniza AMBOS os bancos remotos para KingHost.
  
  OperaÃ§Ãµes:
    â€¢ Conecta a plansul263, plansul104 e KingHost
    â€¢ Puxa registros de tabfant (projetos)
    â€¢ Puxa registros de funcionarios (funcionÃ¡rios)
    â€¢ Sincroniza via UPSERT (insert se nÃ£o existe, update se existe)
    â€¢ Gera logs detalhados
    â€¢ Aceita --dry-run para validar antes de aplicar

TABELAS SINCRONIZADAS:
  1. tabfant
     Campos: id, CDPROJETO, NOMEPROJETO
     Chave: id (primary key)
     Origem: plansul263
     Destino: KingHost.tabfant
  
  2. funcionarios
     Campos: CDMATRFUNCIONARIO, NMFUNCIONARIO, DTADMISSAO, CDCARGO, 
             CODFIL, UFPROJ, DESETOR, DESITUACAO
     Chave: CDMATRFUNCIONARIO (primary key)
     Origem: plansul104
     Destino: KingHost.funcionarios

==================================================================================
PARTE 3: COMO EXECUTAR
==================================================================================

OPÃ‡ÃƒO 1: LOCAL (mÃ¡quina Windows/Linux com PHP 8.2+)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Teste seca (dry-run):
php82 scripts/sync_kinghost_full_plansul263_104.php --dry-run

# ExecuÃ§Ã£o real:
php82 scripts/sync_kinghost_full_plansul263_104.php

Resultado: Log em storage/logs/sync_kinghost_plansul263_104_YYYY-MM-DD_HHmmss.log

OPÃ‡ÃƒO 2: VIA SSH (KingHost direto - RECOMENDADO)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Teste seca:
ssh plansul@ftp.plansul.info "cd ~/www/estoque-laravel && php82 scripts/sync_kinghost_full_plansul263_104.php --dry-run 2>&1"

# ExecuÃ§Ã£o real:
ssh plansul@ftp.plansul.info "cd ~/www/estoque-laravel && php82 scripts/sync_kinghost_full_plansul263_104.php 2>&1"

# Verificar log apÃ³s execuÃ§Ã£o:
ssh plansul@ftp.plansul.info "cd ~/www/estoque-laravel && ls -lah storage/logs/sync_kinghost_plansul263_104_*.log | tail -1"

# Ler Ãºltimo log:
ssh plansul@ftp.plansul.info "cd ~/www/estoque-laravel && tail -50 storage/logs/sync_kinghost_plansul263_104_*.log | tail -50"

==================================================================================
PARTE 4: FLUXO RECOMENDADO
==================================================================================

1. VALIDAÃ‡ÃƒO PRÃ‰-SINCRONIZAÃ‡ÃƒO
   â”œâ”€ Verificar conectividade SSH
   â”œâ”€ Checar espaÃ§o em disco KingHost
   â””â”€ Fazer backup automÃ¡tico (storage/backups/)

2. TESTE SECO (--dry-run)
   â”œâ”€ Executar com --dry-run
   â”œâ”€ Revisar log de simulaÃ§Ã£o
   â””â”€ Validar contagem de registros (+added, ~updated)

3. SINCRONIZAÃ‡ÃƒO REAL
   â”œâ”€ Executar sem flags
   â”œâ”€ Aguardar conclusÃ£o (< 2 min normalmente)
   â””â”€ Validar log final

4. AUDITORIA PÃ“S-SINCRONIZAÃ‡ÃƒO
   â”œâ”€ Comparar contagem de registros
   â”œâ”€ Testar acesso aos dados via interface
   â””â”€ Documentar no changelog

==================================================================================
PARTE 5: ARQUIVOS RELACIONADOS
==================================================================================

SCRIPTS LEGADOS (para referÃªncia):
  â€¢ scripts/puxar_funcionarios_kinghost.php
    â†’ Sincroniza apenas funcionÃ¡rios (plansul104 â†’ local)
  
  â€¢ scripts/puxar_projetos_kinghost.php
    â†’ Sincroniza apenas projetos (plansul263 â†’ local)
  
  â€¢ scripts/sincronizar_funcionarios_projetos_kinghost.php
    â†’ Sincroniza local â†’ KingHost (direÃ§Ã£o oposta)

NOVO SCRIPT CONSOLIDADO:
  â€¢ scripts/sync_kinghost_full_plansul263_104.php
    â†’ Substitui/integra a sincronizaÃ§Ã£o de AMBOS (plansul263+plansul104 â†’ KingHost)
    â†’ RÃ¡pido, robusto e bem documentado

==================================================================================
PARTE 6: LOGS E RASTREABILIDADE
==================================================================================

LOCAL DOS LOGS:
  storage/logs/sync_kinghost_plansul263_104_YYYY-MM-DD_HHmmss.log

FORMATO DO LOG:
  [YYYY-MM-DD HH:mm:ss] NÃVEL MSG
  
  Exemplo:
  [2026-02-05 14:30:45] âœ“ Conectado: plansul263 (Projetos)
  [2026-02-05 14:30:47] ðŸ“‹ SINCRONIZAÃ‡ÃƒO 1: TABFANT
  [2026-02-05 14:30:48] âœ“ Resultado: +5 novos, ~12 atualizados, 0 erros

CAMPOS REGISTRADOS:
  â€¢ Timestamps de inÃ­cio/fim
  â€¢ Modo (DRY-RUN vs PRODUÃ‡ÃƒO)
  â€¢ ConexÃµes estabelecidas
  â€¢ Contagem de registros (origem vs destino)
  â€¢ Resultados por tabela (adds, updates, errors)
  â€¢ Erros detalhados (se houver)

ACESSAR LOGS (SSH):
  ssh plansul@ftp.plansul.info "cat ~/www/estoque-laravel/storage/logs/sync_kinghost_plansul263_104_<YYYY-MM-DD_HHmmss>.log"

==================================================================================
PARTE 7: TRATAMENTO DE ERROS
==================================================================================

ERRO: "mysql07-farm10.kinghost.net: Connection refused"
  â†’ Validar credenciais MySQL no .env
  â†’ Verificar conexÃ£o de rede (testar ping)
  â†’ Contatar suporte KingHost se persistir

ERRO: "Access denied for user 'plansul263@mysql.plansul2.kinghost.net'"
  â†’ Verificar .env: TABFANTASIA_SOURCE_USER / TABFANTASIA_SOURCE_PASS
  â†’ Validar que o bannco plansul263 estÃ¡ acessÃ­vel

ERRO: "Table 'plansul04.tabfant' doesn't exist"
  â†’ SincronizaÃ§Ã£o prÃ©via nÃ£o foi concluÃ­da
  â†’ Executar em --dry-run primeiro para validar estrutura
  â†’ Contatar administrador do banco

ERRO: "1030: Got error 28 from storage engine"
  â†’ Sem espaÃ§o em disco no KingHost
  â†’ Fazer limpeza de backups ou contatar suporte KingHost

==================================================================================
PARTE 8: CHECKLIST PRÃ‰-EXECUÃ‡ÃƒO
==================================================================================

Antes de sincronizar, validar:

  [ ] SSH conectÃ¡vel: ssh plansul@ftp.plansul.info
  [ ] PHP 8.2+ disponÃ­vel: ssh plansul@ftp.plansul.info php82 -v
  [ ] DiretÃ³rio storage/logs/ existe
  [ ] .env carregado corretamente
  [ ] plansul263 acessÃ­vel: testar conexÃ£o
  [ ] plansul104 acessÃ­vel: testar conexÃ£o
  [ ] KingHost acessÃ­vel: testar conexÃ£o
  [ ] EspaÃ§o em disco suficiente (logs + transaÃ§Ãµes)
  [ ] Nenhum script de sincronizaÃ§Ã£o rodando em paralelo

==================================================================================
PARTE 9: AUTOMAÃ‡ÃƒO FUTURA (PARA IA/COPILOT)
==================================================================================

INSTRUÃ‡ÃƒO PARA COPILOT (prÃ³ximas vezes):

Quando usuÃ¡rio pedir: "Sincronizar plansul263 e plansul104 com KingHost"
  1. LER este arquivo (.github/SYNC_KINGHOST_AUTO.txt)
  2. Usar script: scripts/sync_kinghost_full_plansul263_104.php
  3. Executar: ssh plansul@ftp.plansul.info "cd ~/www/estoque-laravel && php82 scripts/sync_kinghost_full_plansul263_104.php --dry-run 2>&1"
  4. Exibir resultado do --dry-run
  5. Aguardar confirmaÃ§Ã£o
  6. Executar: ssh plansul@ftp.plansul.info "cd ~/www/estoque-laravel && php82 scripts/sync_kinghost_full_plansul263_104.php 2>&1"
  7. Verificar log
  8. Relatar status (sucesso/erro)

NÃƒO PEDIR EXPLICAÃ‡Ã•ES NOVAMENTE - usar este arquivo como referÃªncia.

==================================================================================
HISTÃ“RICO DE SINCRONIZAÃ‡Ã•ES
==================================================================================

DATA               OPERAÃ‡ÃƒO              REGISTROS PROCESSADOS    STATUS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2026-02-05        Teste inicial         tabfant: +0, ~0          âœ… OK
                                        funcionarios: +0, ~0
[MANTER ATUALIZADO COM CADA SINCRONIZAÃ‡ÃƒO]

==================================================================================
CONTATO E SUPORTE
==================================================================================

DÃºvidas sobre estrutura do banco:
  â†’ Consultar: .github/copilot-instructions.md (seÃ§Ã£o 14: BANCO DE DADOS)

Problemas tÃ©cnicos (SSH, MySQL):
  â†’ Verificar conectividade: ping mysql.plansul2.kinghost.net
  â†’ Testar MySQL direto: mysql -h mysql.plansul2.kinghost.net -u plansul263 -p

InformaÃ§Ãµes sobre tabelas:
  â†’ Rodar diagnÃ³stico: php scripts/diagnosticar_estrutura_kinghost.php

==================================================================================
FIM DO DOCUMENTO
Criado em: 2026-02-05
Ãšltima atualizaÃ§Ã£o: 2026-02-05
Mantido por: GitHub Copilot (automÃ¡tico)
==================================================================================
