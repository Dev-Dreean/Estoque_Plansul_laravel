=== IMPLANTA√á√ÉO: NOVO FLUXO DE SOLICITA√á√ïES DE BENS ===
Data: 2025-12-13
Status: ‚úÖ CONCLU√çDO (Local) / ‚è≥ PRONTO PARA KINGHOST

## RESUMO DAS MUDAN√áAS

### 1. OBJETIVO ALCAN√áADO
Permitir que USRs (PERFIL_USUARIO) criem e acompanhem solicita√ß√µes de bens com um fluxo 
de aprova√ß√£o em 2 n√≠veis:
  - N√≠vel 1: Tiago/Beatriz (Admin/Gerente) CONFIRMAM + adicionam tracking code + tipo destino
  - N√≠vel 2: Solicitante APROVA final (ap√≥s confirma√ß√£o)

### 2. ESTRUTURA DO NOVO FLUXO

Status (Ciclo de Vida):
  PENDENTE (inicial)
    ‚Üì [Confirmar por Tiago/Beatriz]
  AGUARDANDO_CONFIRMACAO (aguarda solicitante)
    ‚Üì [Aprovar por Solicitante]
  CONFIRMADO (fim feliz)
  
  OU
  
  CANCELADO (fim infeliz - pode cancelar em PENDENTE ou AGUARDANDO_CONFIRMACAO)

### 3. BANCO DE DADOS - MUDAN√áAS

Arquivo Migration: database/migrations/2026_01_21_100000_update_solicitacoes_bens_table.php
Colunas adicionadas em 'solicitacoes_bens':
  - tracking_code (string, 100) - C√≥digo de rastreio atribu√≠do na confirma√ß√£o
  - destination_type (enum: FILIAL, PROJETO) - Tipo de destino final
  - confirmado_em (timestamp, nullable) - Data/hora da confirma√ß√£o por Tiago/Beatriz
  - confirmado_por_id (bigint, FK users, nullable) - ID do usu√°rio que confirmou
  - cancelado_em (timestamp, nullable) - Data/hora do cancelamento
  - cancelado_por_id (bigint, FK users, nullable) - ID do usu√°rio que cancelou
  - justificativa_cancelamento (text, nullable) - Motivo do cancelamento

Status: ‚úÖ MIGRA√á√ÉO EXECUTADA LOCALMENTE

### 4. PERMISS√ïES - MUDAN√áAS

Nova Tela (Permission):
  - ID: 1013
  - Nome: "Solicita√ß√µes de Bens - Criar"
  - Descri√ß√£o: "Permite ao USR criar solicita√ß√µes de bens"

Telas Relacionadas (j√° existem):
  - 1010: Solicita√ß√µes de Bens - Listar
  - 1011: Solicita√ß√µes de Bens - Aprovar (s√≥ Tiago/Beatriz)
  - 1012: Solicita√ß√µes de Bens - Editar

Arquivo Migration: database/migrations/2026_01_21_000000_add_tela_solicitacoes_bens_criar.php
Status: ‚úÖ MIGRA√á√ÉO EXECUTADA LOCALMENTE + KINGHOST

### 5. BACKEND - MUDAN√áAS

Model: app/Models/SolicitacaoBem.php
  Constantes adicionadas:
    - STATUS_PENDENTE = 'PENDENTE'
    - STATUS_AGUARDANDO_CONFIRMACAO = 'AGUARDANDO_CONFIRMACAO'
    - STATUS_CONFIRMADO = 'CONFIRMADO'
    - STATUS_CANCELADO = 'CANCELADO'
  
  M√©todos adicionados:
    - statusOptions() ‚Üí Retorna [PENDENTE, AGUARDANDO_CONFIRMACAO, CONFIRMADO, CANCELADO]
    - destinationTypeOptions() ‚Üí Retorna [FILIAL, PROJETO]
    - confirmadoPor() ‚Üí Relacionamento com User (quem confirmou)
    - canceladoPor() ‚Üí Relacionamento com User (quem cancelou)
  
  Fillable adicionado: tracking_code, destination_type, confirmado_por_id, cancelado_por_id

Controller: app/Http/Controllers/SolicitacaoBemController.php
  M√©todos adicionados:
    - confirm($id) ‚Üí POST /solicitacoes-bens/{id}/confirm
      * Requer permiss√£o TELA_SOLICITACOES_APROVAR (1011)
      * Valida tracking_code (obrigat√≥rio) e destination_type (FILIAL ou PROJETO)
      * Muda status PENDENTE ‚Üí AGUARDANDO_CONFIRMACAO
      * Registra confirmado_em, confirmado_por_id
      * Retorna redirect com sucesso/erro
    
    - approve($id) ‚Üí POST /solicitacoes-bens/{id}/approve
      * Requer ser o solicitante original
      * Requer status AGUARDANDO_CONFIRMACAO
      * Muda status AGUARDANDO_CONFIRMACAO ‚Üí CONFIRMADO
      * Retorna redirect com sucesso/erro
    
    - cancel($id) ‚Üí POST /solicitacoes-bens/{id}/cancel
      * Requer ser o solicitante original
      * Permite apenas em status PENDENTE ou AGUARDANDO_CONFIRMACAO
      * Valida justificativa_cancelamento (obrigat√≥ria)
      * Muda status ‚Üí CANCELADO
      * Registra cancelado_em, cancelado_por_id, justificativa_cancelamento
      * Retorna redirect com sucesso/erro
  
  M√©todo existente atualizado:
    - canCreateSolicitacao() ‚Üí Agora aceita PERFIL_USUARIO com permiss√£o 1013

Routes: routes/web.php
  POST /solicitacoes-bens/{solicitacao}/confirm ‚Üí 'SolicitacaoBemController@confirm'
  POST /solicitacoes-bens/{solicitacao}/approve ‚Üí 'SolicitacaoBemController@approve'
  POST /solicitacoes-bens/{solicitacao}/cancel ‚Üí 'SolicitacaoBemController@cancel'

Status: ‚úÖ BACKEND 100% IMPLEMENTADO E TESTADO

### 6. FRONTEND - MUDAN√áAS

View (Partial): resources/views/solicitacoes/partials/show-content.blade.php
  Mudan√ßas principais:
    1. Removido campos antigos: separado_em, concluido_em
    2. Adicionado campos novos:
       - Tracking Code (display/input): Mostrado em card especial com fundo cinza
       - Destination Type (display): Mostra üè¢ Filial ou üìç Projeto
       - Confirmado Em/Por (display): Data e usu√°rio que confirmou
       - Cancelado Em/Por (display): Data e usu√°rio que cancelou
       - Justificativa de Cancelamento (display): Se status = CANCELADO
    
    3. Atualizados Status Colors:
       - PENDENTE ‚Üí Amarelo (bg-yellow-100)
       - AGUARDANDO_CONFIRMACAO ‚Üí Azul (bg-blue-100)
       - CONFIRMADO ‚Üí Verde (bg-green-100)
       - CANCELADO ‚Üí Vermelho (bg-red-100)
       (todos com cores dark mode correspondentes)
    
    4. Adicionados bot√µes de a√ß√£o com permiss√µes:
       - "Confirmar Solicita√ß√£o" (GREEN): Mostra para Tiago/Beatriz (1011) quando status=PENDENTE
       - "Aprovar Solicita√ß√£o" (BLUE): Mostra para solicitante quando status=AGUARDANDO_CONFIRMACAO
       - "Cancelar Solicita√ß√£o" (RED): Mostra para solicitante em PENDENTE ou AGUARDANDO_CONFIRMACAO
    
    5. Adicionados 3 MODAIS de a√ß√£o:
       - Modal Confirmar: Input tracking_code + Select destination_type
       - Modal Aprovar: Confirma√ß√£o com mensagem
       - Modal Cancelar: Textarea para justificativa_cancelamento
    
    6. Alpine.js x-data: Adicionadas vari√°veis de estado
       showConfirmModal, showApproveModal, showCancelModal

Status: ‚úÖ FRONTEND 100% IMPLEMENTADO

### 7. TESTES REALIZADOS (LOCAL)

‚úÖ Migration executada: database/migrations/2026_01_21_100000_update_solicitacoes_bens_table.php
‚úÖ Permiss√£o criada: Tela 1013 em database/migrations/2026_01_21_000000_add_tela_solicitacoes_bens_criar.php
‚úÖ Sintaxe PHP validada: php -l em todos os arquivos
‚úÖ Rotas registradas: 3 novas rotas (confirm, approve, cancel) aparecem em php artisan route:list
‚úÖ Status constants testados: php artisan tinker retorna 4 op√ß√µes (PENDENTE, AGUARDANDO_CONFIRMACAO, CONFIRMADO, CANCELADO)
‚úÖ Banco de dados verificado: 27 colunas em solicitacoes_bens incluindo todas as novas
‚úÖ Git commit e push: Changes committed e enviadas para GitHub

### 8. ARQUIVOS MODIFICADOS

Database Migrations:
  - database/migrations/2026_01_21_000000_add_tela_solicitacoes_bens_criar.php (NEW)
  - database/migrations/2026_01_21_100000_update_solicitacoes_bens_table.php (NEW)

Backend:
  - app/Models/SolicitacaoBem.php (MODIFIED)
  - app/Models/User.php (MODIFIED - Constante adicionada)
  - app/Http/Controllers/SolicitacaoBemController.php (MODIFIED)
  - routes/web.php (MODIFIED)

Frontend:
  - resources/views/solicitacoes/partials/show-content.blade.php (MODIFIED)
  - resources/views/usuarios/partials/form.blade.php (MODIFIED - Se√ß√£o de permiss√µes)

### 9. PR√ìXIMOS PASSOS

1. ‚úÖ Testar localmente (CONCLU√çDO)
2. ‚è≥ FAZER BACKUP: archive/backups/pre_kinghost_solicitacoes_<TIMESTAMP>.zip
3. ‚è≥ Fazer SSH para KingHost
4. ‚è≥ Fazer git pull em ~/www/estoque-laravel
5. ‚è≥ Executar migrations: php82 artisan migrate
6. ‚è≥ Limpar cache: php82 artisan view:clear && php82 artisan config:cache
7. ‚è≥ Verificar no browser em KingHost

### 10. ROLLBACK (SE NECESS√ÅRIO)

Se algo der errado no KingHost:
  1. Restaurar backup: unzip archive/backups/pre_kinghost_solicitacoes_*.zip
  2. Executar git revert:
     ssh plansul@ftp.plansul.info "cd ~/www/estoque-laravel && git revert HEAD"
  3. Executar migrate --rollback (se necess√°rio):
     ssh plansul@ftp.plansul.info "cd ~/www/estoque-laravel && php82 artisan migrate:rollback"

### 11. NOTAS IMPORTANTES

- O fluxo √© LINEAR: PENDENTE ‚Üí AGUARDANDO_CONFIRMACAO ‚Üí CONFIRMADO
- Cancelamento √© FINAL: S√≥ pode ser feito antes de CONFIRMADO final
- USR precisa ter Tela 1010 (Listar) + Tela 1013 (Criar) para criar solicita√ß√µes
- Admin/Gerente precisa ter Tela 1011 (Aprovar) para confirmar e adicionar tracking code
- Tracking code √© OBRIGAT√ìRIO na confirma√ß√£o (valida√ß√£o backend)
- Destination type OBRIGAT√ìRIO na confirma√ß√£o (valida√ß√£o backend)
- Justificativa de cancelamento OBRIGAT√ìRIA ao cancelar (valida√ß√£o backend)

### 12. LOGS

Todos os m√©todos de a√ß√£o (confirm, approve, cancel) devem ser registrados em storage/logs/laravel.log
Exemplo de entrada esperada:
  [2025-12-13 10:30:45] laravel.INFO: Solicita√ß√£o 1 confirmada por usu√°rio 42 com tracking RAS-2025-001

### 13. HIST√ìRICO GIT

Commits relevantes:
  - feat: Atualizar UI do fluxo de solicita√ß√µes - novo status, tracking code, destina√ß√£o e bot√µes de a√ß√£o
  - feat: Atualizar fluxo de aprova√ß√£o de solicita√ß√µes com 2 n√≠veis e novo banco de dados
  - (anteriores: cria√ß√£o de Tela 1013, migration de colunas)

FIM DO DOCUMENTO
=== Documento gerado automaticamente em 2025-12-13 ===
