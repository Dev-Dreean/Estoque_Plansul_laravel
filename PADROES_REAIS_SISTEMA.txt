================================================================================
PADRÃ•ES REAIS DO SISTEMA - GUIA PRÃTICO PARA DESENVOLVIMENTO
2026-02-02 | AnÃ¡lise de cÃ³digo REAL do projeto
================================================================================

ğŸ“Œ INTRO:
Este documento Ã© 100% baseado em anÃ¡lise do cÃ³digo existente. Sem ideais. 
Sem "deveria ser". Ã‰ COMO FUNCIONA AGORA. Use como referÃªncia absoluta.

================================================================================
1ï¸âƒ£ TIPOS DE TELAS (PadrÃ£o Real)
================================================================================

PADRÃƒO PREDOMINANTE:
â”œâ”€ 85% CRUD Simples (Index + Create + Edit + Delete)
â”œâ”€ 15% Telas Customizadas (Atribuir, RelatÃ³rios, etc)

Estrutura Standard:

INDEX (Listagem):
â”œâ”€ Flash messages (success/error)
â”œâ”€ Filtro (Form + AJAX) 
â”œâ”€ Tabela com paginaÃ§Ã£o
â”œâ”€ AÃ§Ãµes por linha (Edit, Delete)
â”œâ”€ SeleÃ§Ã£o mÃºltipla (checkboxes)
â”œâ”€ AÃ§Ãµes em massa (Bulk update, Bulk delete)
â””â”€ Modais para operaÃ§Ãµes complexas

Exemplo real: patrimonios/index.blade.php
â”œâ”€ Flash: @include('patrimonios.partials.flash-messages')
â”œâ”€ Filtro: @include('patrimonios.partials.filter-form')
â”œâ”€ BotÃµes aÃ§Ã£o: @include('patrimonios.partials.action-buttons')
â”œâ”€ Barra seleÃ§Ã£o: bulk-status-bar
â”œâ”€ Tabela: rows dinÃ¢micas via Alpine
â””â”€ Modais: deleteModalOpen, showConsultaModal, bulk-confirm-modal

CREATE:
â”œâ”€ Form Ãºnico (patrimonio-form.blade.php)
â”œâ”€ Pode ser modal ou pÃ¡gina
â”œâ”€ Valida no frontend + backend
â””â”€ Redirect com flash message

EDIT:
â”œâ”€ Same form como Create
â”œâ”€ Modal OU pÃ¡gina (?modal=1 param)
â”œâ”€ Detecta mudanÃ§as (Alpine compare)
â”œâ”€ Modal de confirmaÃ§Ã£o antes de salvar
â””â”€ Redirect com flash message

DELETE:
â”œâ”€ Modal de confirmaÃ§Ã£o obrigatÃ³rio
â”œâ”€ DELETE via AJAX (fetch)
â”œâ”€ Resposta 204 ou 200
â”œâ”€ Remove row da tabela (animado)
â””â”€ Flash message NO PRÃ“XIMO LOAD

================================================================================
2ï¸âƒ£ CONVENÃ‡ÃƒO DE ROTAS E PERMISSÃ•ES
================================================================================

PADRÃƒO ROTAS:

Route::resource('patrimonios', PatrimonioController::class)
  ->middleware(['tela.access:1000']);

SIGNIFICA:
â”œâ”€ GET /patrimonios â†’ index
â”œâ”€ POST /patrimonios â†’ store
â”œâ”€ GET /patrimonios/create â†’ create
â”œâ”€ GET /patrimonios/{id}/edit â†’ edit
â”œâ”€ PUT/PATCH /patrimonios/{id} â†’ update
â”œâ”€ DELETE /patrimonios/{id} â†’ destroy
â””â”€ GET /patrimonios/{id} â†’ show

ROTAS CUSTOMIZADAS (APIs):
â”œâ”€ GET /api/patrimonios/id/{id} â†’ buscarPorId (JSON)
â”œâ”€ GET /api/patrimonios/pesquisar?q=termo â†’ pesquisar (JSON)
â”œâ”€ POST /patrimonios/bulk-update â†’ bulk update (JSON)
â”œâ”€ POST /patrimonios/bulk-delete â†’ bulk delete (JSON)
â””â”€ POST /patrimonios/bulk-verify â†’ bulk verify conferido (JSON)

PREFIXOS:
â”œâ”€ /patrimonios (patrimÃ´nios)
â”œâ”€ /usuarios (usuÃ¡rios)
â”œâ”€ /projetos (projetos)
â”œâ”€ /api/ (APIs JSON)
â”œâ”€ Sem /admin (controle via middleware tela.access)
â””â”€ Sem /sistema (nÃ£o Ã© padrÃ£o)

PERMISSÃ•ES (Policy + Middleware):

1. MIDDLEWARE tela.access:1000
   â”œâ”€ Checa se user tem acesso Ã  tela NUSEQTELA=1000
   â”œâ”€ Usa tabela acessousuario (BD)
   â””â”€ Rejeita 403 se nÃ£o tem acesso

2. POLICY (PatrimonioPolicy.php)
   â”œâ”€ before() â†’ admin/god sempre passa
   â”œâ”€ PERFIL='ADM' â†’ acesso total
   â”œâ”€ PERFIL='C' â†’ visualizar apenas (view, viewAny)
   â”œâ”€ PERFIL='USR' â†’ criar/editar/deletar
   â””â”€ Autoriza com: $this->authorize('update', $patrimonio)

3. Authorization Exception
   â”œâ”€ Se falhar: throw AuthorizationException
   â”œâ”€ Controller retorna: 403 response
   â””â”€ UsuÃ¡rio vÃª: mensagem erro + redirect

Estrutura Real (em cÃ³digo):
```
Route::resource('patrimonios', PatrimonioController::class)
  ->middleware(['auth', 'tela.access:1000']);

public function edit(Patrimonio $patrimonio) {
    $this->authorize('update', $patrimonio); // Checa policy
    return view('patrimonios.edit', ['patrimonio' => $patrimonio]);
}

public function update(Request $request, Patrimonio $patrimonio) {
    $this->authorize('update', $patrimonio); // Checa policy
    // ... resto lÃ³gica
}
```

NUNCA usa:
â”œâ”€ spatie/permission
â”œâ”€ gates
â”œâ”€ middleware customizados para permission (policy Ã© bastante)
â””â”€ autorizaÃ§Ã£o em Blade (@can jÃ¡ funciona com policy)

================================================================================
3ï¸âƒ£ PADRÃƒO DE FEEDBACK PARA USUÃRIO
================================================================================

FLASH MESSAGES (ApÃ³s aÃ§Ã£o no server):

Tipos:
â”œâ”€ success: "PatrimÃ´nio criado com sucesso!"
â”œâ”€ error: "Erro ao deletar patrimÃ´nio"
â””â”€ warning: (raramente usado)

Retorno Controller:
```
return redirect()->route('patrimonios.index')
  ->with('success', 'PatrimÃ´nio criado!');

return redirect()->back()
  ->with('error', 'Erro ao atualizar!');
```

Render em Blade:
```
@if(session('success'))
  <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
    <strong>Sucesso!</strong> {{ session('success') }}
  </div>
@endif

@if(session('error'))
  <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
    <strong>Erro!</strong> {{ session('error') }}
  </div>
@endif
```

PADRÃƒO: Componente reutilizÃ¡vel
```
@include('patrimonios.partials.flash-messages')
```

Toast Notification (Modal em tempo real via Alpine):
â”œâ”€ Fixed top-right / bottom-right
â”œâ”€ Auto-dismiss (3-5s)
â”œâ”€ Tipo: 'sucesso' ou 'erro'
â”œâ”€ Alpine x-data com show/hide
â””â”€ Triggers via @click ou em response AJAX

Real example (projetos/_table_partial.blade.php):
```
<div x-show="toast.show" x-transition class="fixed top-4 right-4 z-50">
  <div :class="toast.tipo === 'sucesso' ? 'bg-green-50' : 'bg-red-50'">
    <p x-text="toast.mensagem"></p>
  </div>
</div>

// Em Alpine:
mostrarToast(mensagem, tipo = 'sucesso', duracao = 3000) {
  this.toast.mensagem = mensagem;
  this.toast.tipo = tipo;
  this.toast.show = true;
  setTimeout(() => { this.toast.show = false; }, duracao);
}
```

Alert em JS puro (backup):
```
alert('Erro ao excluir: ' + error.message);
```

NUNCA usa:
â”œâ”€ Toastr.js ou similares (Alpine Ã© bastante)
â”œâ”€ SweetAlert (use modal Alpine)
â””â”€ NotificaÃ§Ã£o por socket (nÃ£o hÃ¡ WebSocket)

================================================================================
4ï¸âƒ£ PADRÃƒO DE JAVASCRIPT (IMPORTANTE!)
================================================================================

ALPINE.JS:
â”œâ”€ Inline em Blade (x-data direto)
â”œâ”€ Sem separate files (raramente)
â”œâ”€ Reatividade simples (data-binding x-model)
â”œâ”€ Event handling (@click, @submit, etc)
â””â”€ TransiÃ§Ãµes (x-transition)

FETCH (NÃ£o axios):
â”œâ”€ Native fetch() API
â”œâ”€ Headers: X-CSRF-TOKEN, Accept, Content-Type
â”œâ”€ Method: DELETE, POST, PATCH
â”œâ”€ Response: .json() ou .text()
â””â”€ Error handling: try/catch ou .catch()

PadrÃ£o para DELETE com confirmaÃ§Ã£o:
```javascript
openDelete(id, name) {
  this.deleteItemId = id;
  this.deleteItemName = name;
  this.deleteModalOpen = true; // Abre modal
}

confirmDelete() {
  if (!this.deleteItemId) return;
  this.deleting = true;
  
  fetch(`/patrimonios/${this.deleteItemId}`, {
    method: 'DELETE',
    headers: {
      'X-CSRF-TOKEN': this.csrf(),
      'Accept': 'application/json',
    },
  })
    .then(resp => {
      if (resp.ok || resp.status === 204) return;
      throw new Error(`HTTP ${resp.status}`);
    })
    .then(() => {
      this.removeRow(this.deleteItemId);
      this.deleteModalOpen = false;
    })
    .catch(err => alert(err.message));
}

removeRow(id) {
  const row = document.querySelector(`[data-row-id="${id}"]`);
  if (row) {
    row.style.opacity = '0';
    setTimeout(() => row.remove(), 300);
  }
}
```

PadrÃ£o para Modal (AJAX):
```javascript
openFormModal(mode, id = null) {
  const url = mode === 'create' 
    ? '/solicitacoes-bens/create?modal=1'
    : `/solicitacoes-bens/${id}/edit?modal=1`;

  fetch(url, {
    headers: { 'X-Requested-With': 'XMLHttpRequest' },
  })
    .then(resp => resp.text())
    .then(html => {
      this.formModalContent = html;
      this.formModalOpen = true;
    })
    .catch(err => alert(err.message));
}
```

PadrÃ£o para Pesquisa/Filtro (debounce):
```javascript
// Em Alpine x-data:
filter: {
  termo: '',
  resultados: [],
  loading: false,
},

async buscar(termo) {
  if (termo.length < 2) {
    this.filter.resultados = [];
    return;
  }

  this.filter.loading = true;
  
  fetch(`/api/patrimonios/pesquisar?q=${termo}`)
    .then(r => r.json())
    .then(data => {
      this.filter.resultados = data.patrimonios || [];
    })
    .finally(() => this.filter.loading = false);
},

// Com debounce:
onFilterInput() {
  clearTimeout(this.filterTimeout);
  this.filterTimeout = setTimeout(() => {
    this.buscar(this.filter.termo);
  }, 500); // 500ms debounce
}
```

MÃ“DULOS JS (reutilizÃ¡veis):
â”œâ”€ public/js/patrimonio-actions.js (delete/rebind)
â”œâ”€ PadrÃ£o IIFE (Immediately Invoked Function Expression)
â”œâ”€ window.PatrimonioActions = (() => { ... })()
â”œâ”€ MÃ©todos pÃºblicos (init, delete, rebind)
â””â”€ LÃ³gica privada (funÃ§Ãµes internas)

Real example:
```javascript
const PatrimonioActions = (function() {
  const defaults = { deleteUrl: '/patrimonios' };
  let config = { ...defaults };

  async function deletarPatrimonio(id, nome) {
    const confirmar = confirm(`Deletar "${nome}"?`);
    if (!confirmar) return;

    try {
      const response = await fetch(`${config.deleteUrl}/${id}`, {
        method: 'DELETE',
        headers: { 'X-CSRF-TOKEN': getCsrfToken() },
      });
      if (!response.ok) throw new Error('Erro ao deletar');
      window.location.reload();
    } catch (err) {
      alert(err.message);
    }
  }

  return {
    init(options = {}) {
      config = { ...defaults, ...options };
    },
    delete(id, nome) {
      return deletarPatrimonio(id, nome);
    },
  };
})();

// Usar:
PatrimonioActions.init({ deleteUrl: '/patrimonios' });
PatrimonioActions.delete(123, 'PatrimÃ´nio X');
```

NUNCA:
â”œâ”€ JavaScript em arquivo separado (sÃ³ IIFE ou Alpine)
â”œâ”€ jQuery (nÃ£o hÃ¡ jQuery)
â”œâ”€ Axios (use fetch)
â”œâ”€ VueJS ou React (use Alpine)
â””â”€ Webpack (use Vite)

================================================================================
5ï¸âƒ£ PADRÃƒO DE DADOS "SENSÃVEIS" / CRÃTICOS
================================================================================

SOFT DELETE:
â”œâ”€ NÃ£o Ã© padrÃ£o no projeto
â”œâ”€ Deletar Ã© permanente (fÃ­sico)
â”œâ”€ Backup feito ANTES em storage/backups/

LOG OBRIGATÃ“RIO para:
â”œâ”€ âœ… CREATE: Log::info('âœ… [Service] patrimÃ´nio criado', [...])
â”œâ”€ âœ… UPDATE: Log::info('âœï¸ [Service] patrimÃ´nio atualizado', [...])
â”œâ”€ âœ… DELETE: Log::error('ğŸ—‘ï¸ [Service] patrimÃ´nio deletado', [...])
â”œâ”€ âœ… AUTH: Login/logout/failed attempts
â”œâ”€ âœ… BULK: OperaÃ§Ãµes em massa
â”œâ”€ âœ… IMPORT: ImportaÃ§Ã£o arquivo
â””â”€ âœ… EXPORT: ExportaÃ§Ã£o relatÃ³rio

Campos NUNCA editÃ¡veis apÃ³s criaÃ§Ã£o:
â”œâ”€ NUSEQPATR (PK patrimÃ´nio)
â”œâ”€ NUPATRIMONIO (nÃºmero patrimÃ´nio)
â”œâ”€ DTAQUISICAO (se jÃ¡ tem valor)
â””â”€ created_at, updated_by (sistema)

Campos CRITICOS:
â”œâ”€ CDMATRFUNCIONARIO (funcionÃ¡rio responsÃ¡vel)
â”œâ”€ CDLOCAL (local fÃ­sico)
â”œâ”€ SITUACAO (ativo/inativo/baixado)
â”œâ”€ Password (hashed bcrypt)
â””â”€ Email (validado Ãºnico)

Auditoria Implementada:
â”œâ”€ updated_by (quem atualizou) - raramente usado
â”œâ”€ created_at / updated_at (timestamps)
â”œâ”€ Tabela movpartr (histÃ³rico de movimentaÃ§Ã£o)
â”œâ”€ Tabela historico_movimentacao (alteraÃ§Ãµes)
â””â”€ Logs em storage/logs/laravel.log

IMPORTANTE: Backups MANUAIS:
â”œâ”€ NÃ£o hÃ¡ backup automÃ¡tico
â”œâ”€ SEMPRE fazer antes de operaÃ§Ã£o em massa:
   
   php artisan backup:database
   
â”œâ”€ Arquivo em: storage/backups/patrimonio_*.json
â””â”€ Restaurar manualmente se necessÃ¡rio

================================================================================
6ï¸âƒ£ MAPA DE DOR (Onde dÃ¡ ruim)
================================================================================

PROBLEMAS CRÃ”NICOS:

ğŸ”´ VALIDAÃ‡ÃƒO DUPLICADA:
â”œâ”€ Valida em FormRequest (server)
â”œâ”€ Valida NOVAMENTE em Alpine (client)
â”œâ”€ Resultado: cÃ³digo repetido, bugs
â”œâ”€ SoluÃ§Ã£o: Server-side rules (Ãºnica fonte verdade)

ğŸ”´ FILTRO SEMPRE QUEBRA:
â”œâ”€ Filtro funciona AJAX
â”œâ”€ Pagination volta pra pÃ¡gina 1
â”œâ”€ Status de seleÃ§Ã£o se perde
â”œâ”€ Resultado: usuÃ¡rio vÃª "sumiu meu registro"
â”œâ”€ Causa: .withQueryString() sÃ³ funciona GET
â”œâ”€ SoluÃ§Ã£o: Manter estado no localStorage ou session

ğŸ”´ MODAL CREATE vs EDIT:
â”œâ”€ Sometimes form Ã© inline blade
â”œâ”€ Sometimes form Ã© carregado via AJAX
â”œâ”€ Resultado: inconsistÃªncia
â”œâ”€ SoluÃ§Ã£o: Usar create.blade.php e edit.blade.php (pÃ¡ginas)

ğŸ”´ PERMISSION CHECK FALTANDO:
â”œâ”€ Policy nÃ£o cobre todos controllers
â”œâ”€ UsuÃ¡rio consegue acessar URL direto
â”œâ”€ Resultado: 500 erro ao invÃ©s de 403
â”œâ”€ SoluÃ§Ã£o: @authorize() SEMPRE apÃ³s carregar model

ğŸ”´ JAVASCRIPT NÃƒO REBIND APÃ“S AJAX:
â”œâ”€ Delete funciona primeira vez
â”œâ”€ Depois de AJAX refresh, delete nÃ£o funciona
â”œâ”€ Causa: DOM mudou, event listeners se perderam
â”œâ”€ SoluÃ§Ã£o: MutationObserver ou observer padrÃ£o

ğŸ”´ FLASH MESSAGE NÃƒO APARECE EM AJAX:
â”œâ”€ Flash salvo em session
â”œâ”€ AJAX retorna HTML sem flash
â”œâ”€ Resultado: "cliquei e nada aconteceu"
â”œâ”€ SoluÃ§Ã£o: Retornar JSON + toast Alpine

ğŸ”´ DATA-ROW-ID MISMATCH:
â”œâ”€ HTML tem: data-row-id="123"
â”œâ”€ JavaScript procura: data-row-id="456"
â”œâ”€ Resultado: row nÃ£o deleta
â”œâ”€ SoluÃ§Ã£o: Usar NUSEQPATR (int) como ID

ğŸ”´ DARK MODE INCONSISTÃŠNCIA:
â”œâ”€ Alguns componentes esquecen "dark:"
â”œâ”€ Resultado: branco em fundo branco
â”œâ”€ SoluÃ§Ã£o: TODA cor precisa dark: par

ğŸ”´ PERFORMANCE NA LISTA:
â”œâ”€ Pagina com 10k patrimÃ´nios carrega lento
â”œâ”€ Cause: Sem Ã­ndices ou N+1 queries
â”œâ”€ SoluÃ§Ã£o: eager load (->with()) e Ã­ndices BD

ğŸ”´ MODAL NÃƒO FECHA DEPOIS:
â”œâ”€ @click="close=false" nÃ£o funciona sempre
â”œâ”€ Cause: event.stopPropagation() ou @click.self
â”œâ”€ SoluÃ§Ã£o: @click.outside + testar ESC key

================================================================================
7ï¸âƒ£ O QUE NUNCA QUER VER DE NOVO
================================================================================

âŒ NUNCA CRIAR CSS NOVO:
â”œâ”€ Sempre usar classes Tailwind existentes
â”œâ”€ Se precisa cor, adicione em tailwind.config.js
â”œâ”€ Nunca: <style> tags inline
â”œâ”€ Nunca: classes customizadas .minha-class

âŒ NUNCA LÃ“GICA EM BLADE:
â”œâ”€ LÃ³gica complexa vai em Service
â”œâ”€ Blade = apenas apresentaÃ§Ã£o
â”œâ”€ Nunca: @php com loops/cÃ¡lculos complexos
â”œâ”€ Nunca: $patrimonio->delete() direto em view

âŒ NUNCA QUERY NO CONTROLLER:
â”œâ”€ Controllers usam Services
â”œâ”€ Services usam Models
â”œâ”€ Nunca: DB::table() no controller
â”œâ”€ Nunca: Patrimonio::where()->get() inline

âŒ NUNCA DUPLICAR COMPONENTE:
â”œâ”€ Se existe action-button, usa ele
â”œâ”€ Se precisa variaÃ§Ã£o, modifica componente
â”œâ”€ Nunca: copiar/colar um componente

âŒ NUNCA SEM AUTORIZAÃ‡ÃƒO:
â”œâ”€ TODO controller precisa $this->authorize()
â”œâ”€ TODO CRUD precisa check permissÃ£o
â”œâ”€ Nunca: assumir user jÃ¡ Ã© autorizado
â”œâ”€ Nunca: saltar @can em Blade

âŒ NUNCA VALIDAÃ‡ÃƒO INCONSISTENTE:
â”œâ”€ Rules = mesmo FormRequest (tanto create quanto update)
â”œâ”€ Se precisar diferente, cria novo FormRequest
â”œâ”€ Nunca: validaÃ§Ã£o diferente em controller

âŒ NUNCA FETCH SEM ERROR HANDLING:
â”œâ”€ Todo fetch precisa .catch()
â”œâ”€ Todo response precisa status check
â”œâ”€ Nunca: "if (resp.ok) continue"
â”œâ”€ Nunca: await fetch sem try/catch

âŒ NUNCA LOG SEM CONTEXTO:
â”œâ”€ Log SEMPRE com array de dados
â”œâ”€ Nunca: Log::info('algo aconteceu')
â”œâ”€ Sempre: Log::info('algo', ['user' => $id, 'patrimonio' => $patr])

âŒ NUNCA HARDCODE URL:
â”œâ”€ Use route() helper
â”œâ”€ Nunca: href="/patrimonios/123"
â”œâ”€ Sempre: :href="route('patrimonios.edit', $patr)"

âŒ NUNCA SEM X-CSRF-TOKEN:
â”œâ”€ TODO fetch POST/DELETE/PATCH precisa token
â”œâ”€ Nunca: <form> sem @csrf
â”œâ”€ Nunca: fetch sem 'X-CSRF-TOKEN' header

âŒ NUNCA ALERT() EM PRODUÃ‡ÃƒO:
â”œâ”€ alert() Ã© para debug rÃ¡pido
â”œâ”€ Use toast/modal para usuÃ¡rios
â”œâ”€ Nunca: deixar alert em cÃ³digo final

âŒ NUNCA CONSOLE.LOG SENSÃVEL:
â”œâ”€ NÃ£o logar passwords/tokens
â”œâ”€ NÃ£o logar dados PII
â”œâ”€ Log pÃºblicas/estruturais sÃ³

================================================================================
8ï¸âƒ£ EXEMPLO PRÃTICO COMPLETO (NEW FEATURE)
================================================================================

TAREFA: Adicionar campo "CODIGO_BARRAS" em PatrimÃ´nio

1ï¸âƒ£ DATABASE:
```php
// database/migrations/2025_02_02_add_codigo_barras.php
Schema::table('patr', function (Blueprint $table) {
    $table->string('CODIGO_BARRAS', 50)->nullable();
    $table->index('CODIGO_BARRAS'); // Para busca rÃ¡pida
});
```

2ï¸âƒ£ MODEL:
```php
// app/Models/Patrimonio.php
class Patrimonio extends Model {
    protected $fillable = [
        // ... existing
        'CODIGO_BARRAS',
    ];
}
```

3ï¸âƒ£ FORMREQUEST:
```php
// app/Http/Requests/StorePatrimonioRequest.php
public function rules(): array {
    return [
        // ... existing
        'CODIGO_BARRAS' => 'nullable|string|max:50|unique:patr',
    ];
}
```

4ï¸âƒ£ CONTROLLER (padrÃ£o):
```php
public function create(): View {
    $this->authorize('create', Patrimonio::class);
    $projetos = Tabfant::select('CDPROJETO', 'NOMEPROJETO')->get();
    return view('patrimonios.create', compact('projetos'));
}

public function store(StorePatrimonioRequest $request): RedirectResponse {
    $patrimonio = Patrimonio::create($request->validated());
    Log::info('âœ… [Patrimonio] criado', ['id' => $patrimonio->NUSEQPATR]);
    return redirect()->route('patrimonios.show', $patrimonio)
        ->with('success', 'PatrimÃ´nio criado!');
}
```

5ï¸âƒ£ BLADE VIEW:
```blade
<!-- resources/views/patrimonios/partials/form.blade.php -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
  {{-- Campos existentes --}}
  
  {{-- NEW FIELD --}}
  <div>
    <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">
      CÃ³digo de Barras
    </label>
    <input type="text" name="CODIGO_BARRAS" 
      value="{{ old('CODIGO_BARRAS', $patrimonio?->CODIGO_BARRAS) }}"
      class="block w-full h-8 text-xs border-gray-300 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-300 rounded-md" />
  </div>
</div>
```

6ï¸âƒ£ TESTAR:
```
âœ… Cria patrimÃ´nio com cÃ³digo_barras
âœ… Busca por cÃ³digo_barras funciona
âœ… Dark mode funciona
âœ… Mobile responsivo
âœ… ValidaÃ§Ã£o funciona (Ãºnico)
âœ… DELETE propaga
âœ… Logs aparecem
```

================================================================================
9ï¸âƒ£ CHECKLIST RÃPIDO (Quando criar TUDO novo)
================================================================================

ANTES:
[ ] Leia este arquivo completo (vocÃª chegou atÃ© aqui!)
[ ] Analise tela SIMILAR existente como referÃªncia
[ ] Crie branch git: git checkout -b feature/nome

DURANTE IMPLEMENTAÃ‡ÃƒO:

Banco/Model:
[ ] Migration criada (se precisa campo novo)
[ ] Model fillable atualizado
[ ] Ãndices adicionados (se busca)
[ ] Relacionamentos testados

Backend:
[ ] FormRequest com regras validaÃ§Ã£o
[ ] Controller com authorize TODOS os mÃ©todos
[ ] Service encapsula lÃ³gica complexa
[ ] Logs com emoji + contexto
[ ] Error handling (try/catch) existente

Frontend:
[ ] Flash messages aparecem
[ ] ValidaÃ§Ã£o client SIMPLES (nÃ£o duplica server)
[ ] Modal confirmaÃ§Ã£o para delete
[ ] Fetch com headers CSRF
[ ] Dark mode COMPLETO (toda cor tem dark:)
[ ] Mobile testado

DEPOIS:
[ ] Nenhum CSS customizado
[ ] Nenhuma lÃ³gica em Blade
[ ] Nenhuma query no Controller
[ ] Nenhuma autorizaÃ§Ã£o faltando
[ ] Nenhuma fetch sem catch
[ ] Nenhum log sem contexto
[ ] Testado create/edit/delete
[ ] Testado filtros/busca
[ ] Testado permissÃµes (403 aparece)

GIT:
[ ] git add .
[ ] git commit -m "âœ… Feature: Nome da feature"
[ ] (Aguardar push autorizaÃ§Ã£o)

================================================================================
ğŸ”¥ QUICK REFERENCE (Copiar/colar quando escrever novo cÃ³digo)
================================================================================

FLASH + REDIRECT:
return redirect()->route('patrimonios.index')
    ->with('success', 'OperaÃ§Ã£o bem-sucedida!');

LOG COM EMOJI:
Log::info('âœ… [PatrimonioService] aÃ§Ã£o concluÃ­da', [
    'user' => Auth::user()->NMLOGIN,
    'id' => $patrimonio->NUSEQPATR,
]);

FETCH COM TRATAMENTO:
fetch('/api/endpoint', {
    method: 'POST',
    headers: {
        'X-CSRF-TOKEN': document.querySelector('[name="_token"]').value,
        'Accept': 'application/json',
    },
    body: JSON.stringify({ data: value }),
})
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      this.mostrarToast('Sucesso!', 'sucesso');
    } else {
      alert(data.error || 'Erro desconhecido');
    }
  })
  .catch(err => alert('Erro: ' + err.message));

AUTHORIZE + DELETE:
$this->authorize('delete', $patrimonio);
try {
    $patrimonio->delete();
    return response('', 204);
} catch (Exception $e) {
    Log::error('âŒ Erro delete', ['error' => $e->getMessage()]);
    return response()->json(['error' => 'Erro ao deletar'], 500);
}

TOAST ALPINE:
mostrarToast(msg, tipo = 'sucesso') {
  this.toast.msg = msg;
  this.toast.tipo = tipo;
  this.toast.show = true;
  setTimeout(() => { this.toast.show = false; }, 3000);
}

VALIDAÃ‡ÃƒO FORMREQUEST:
public function rules(): array {
    return [
        'campo' => 'required|string|max:100|unique:tabela,coluna',
    ];
}

public function messages(): array {
    return [
        'campo.required' => 'Este campo Ã© obrigatÃ³rio',
        'campo.unique' => 'Este valor jÃ¡ existe',
    ];
}

POLICY:
public function before(User $user, string $ability): bool|null {
    if ($user->isGod()) return true;
    if ($user->PERFIL === 'ADM') return true;
    return null; // continua checking mÃ©todo especÃ­fico
}

public function update(User $user, Patrimonio $p): bool {
    return true; // admin jÃ¡ passou no before
}

DARK MODE (TAILWIND):
class="
  bg-white dark:bg-gray-800
  text-gray-900 dark:text-gray-100
  border-gray-200 dark:border-gray-700
  hover:bg-gray-100 dark:hover:bg-gray-700
"

================================================================================
ğŸ” CONTRATOS IRREVOGÃVEIS (Sem discussÃ£o, sem exceÃ§Ã£o)
================================================================================

Estes padrÃµes NÃƒO tÃªm alternativa. Codex segue EXATAMENTE como descrito.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#1: MODAL vs PÃGINA (Contrato)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

REGRA ABSOLUTA:

Create:
â”œâ”€ PÃGINA: GET /patrimonios/create â†’ resources/views/patrimonios/create.blade.php
â”œâ”€ Flash message apÃ³s store
â”œâ”€ Redirect para show/index
â””â”€ NUNCA modal por padrÃ£o

Edit:
â”œâ”€ PÃGINA: GET /patrimonios/{id}/edit â†’ resources/views/patrimonios/edit.blade.php
â”œâ”€ Flash message apÃ³s update
â”œâ”€ Redirect para show
â””â”€ Modal pode ser carregado via ?modal=1 (opt-in)

Modal Ã© APENAS para:
â”œâ”€ AÃ§Ãµes secundÃ¡rias (confirm delete, preview, mini-form)
â”œâ”€ OperaÃ§Ãµes rÃ¡pidas dentro da mesma pÃ¡gina (nÃ£o navigate)
â”œâ”€ Bulk operations (select multiple â†’ apply action)
â””â”€ NUNCA para criar/editar registro completo (use pÃ¡gina)

ImplementaÃ§Ã£o Modal:
```blade
<!-- NUNCA abrir modal automÃ¡tico em create/edit -->
<!-- Modal deve vir do usuÃ¡rio clicar em botÃ£o -->
<button @click="deleteModalOpen = true">Deletar</button>

<!-- Modal structure padrÃ£o -->
<div x-show="deleteModalOpen" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-black/60">
  <div @click.stop class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6">
    <h3 class="text-lg font-semibold">Confirmar aÃ§Ã£o</h3>
    <p class="text-gray-600 dark:text-gray-300 mt-2">Mensagem aqui</p>
    <div class="mt-6 flex gap-3 justify-end">
      <button @click="deleteModalOpen = false">Cancelar</button>
      <button @click="confirmar()">Confirmar</button>
    </div>
  </div>
</div>
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#2: JSON SHAPE (Contrato de API Responses)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

PADRÃƒO ÃšNICO para TODAS as respostas JSON:

âœ… SUCESSO (GET / list):
{
  "success": true,
  "data": {
    "patrimonios": [ { ... } ],
    "total": 150,
    "per_page": 30,
    "current_page": 1,
    "last_page": 5
  },
  "message": "Listagem carregada"
}

âœ… SUCESSO (POST / create or update):
{
  "success": true,
  "data": {
    "NUSEQPATR": 123,
    "NUPATRIMONIO": "PAT-2025-001",
    "DEPATRIMONIO": "Monitor 27\""
  },
  "message": "PatrimÃ´nio criado com sucesso!"
}

âœ… SUCESSO (DELETE / single):
{
  "success": true,
  "message": "PatrimÃ´nio deletado",
  "data": null
}

âœ… SUCESSO (Bulk operation):
{
  "success": true,
  "data": {
    "processados": 50,
    "erros": 2,
    "detalhes": [
      { "id": 1, "status": "ok" },
      { "id": 2, "status": "erro", "motivo": "sem permissÃ£o" }
    ]
  },
  "message": "50 itens processados, 2 com erro"
}

âŒ ERRO (ValidaÃ§Ã£o):
{
  "success": false,
  "errors": {
    "NUPATRIMONIO": ["JÃ¡ existe"],
    "DEPATRIMONIO": ["ObrigatÃ³rio"]
  },
  "message": "ValidaÃ§Ã£o falhou"
}

âŒ ERRO (Geral):
{
  "success": false,
  "error": "Erro ao processar",
  "message": "Tente novamente"
}

REGRAS:
â”œâ”€ SEMPRE "success" (boolean)
â”œâ”€ SEMPRE "message" ou "error" (string)
â”œâ”€ "data" = null se sem dados
â”œâ”€ "errors" = array key=>message APENAS validaÃ§Ã£o
â”œâ”€ HTTP status: 200 ok, 422 validaÃ§Ã£o, 403 permissÃ£o, 500 erro
â””â”€ NUNCA "resultado", "payload", "info" (sempre "data")

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#3: FILTRO STATE (Contrato de persistÃªncia)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

PADRÃƒO ÃšNICO: URL Query String (fonte Ãºnica verdade)

Estrutura:
GET /patrimonios?cdprojeto=8&cdlocal=001&situacao=Ativo&page=2

Controller:
```php
public function index(Request $request): View {
    $cdprojeto = $request->input('cdprojeto');
    $cdlocal = $request->input('cdlocal');
    $situacao = $request->input('situacao');
    
    $patrimonios = Patrimonio::query()
        ->when($cdprojeto, fn($q) => $q->where('CDPROJETO', $cdprojeto))
        ->when($cdlocal, fn($q) => $q->where('CDLOCAL', $cdlocal))
        ->when($situacao, fn($q) => $q->where('SITUACAO', $situacao))
        ->paginate(30)
        ->withQueryString(); // â† IMPORTANTE: mantÃ©m query na paginaÃ§Ã£o
    
    return view('patrimonios.index', compact('patrimonios'));
}
```

Blade (Form):
```blade
<form action="{{ route('patrimonios.index') }}" method="GET" class="flex gap-2">
    <input type="text" name="cdprojeto" value="{{ request('cdprojeto') }}" placeholder="Projeto" />
    <input type="text" name="cdlocal" value="{{ request('cdlocal') }}" placeholder="Local" />
    <select name="situacao">
        <option value="">Todas</option>
        <option value="Ativo" {{ request('situacao') === 'Ativo' ? 'selected' : '' }}>Ativo</option>
        <option value="Inativo" {{ request('situacao') === 'Inativo' ? 'selected' : '' }}>Inativo</option>
    </select>
    <button type="submit">Filtrar</button>
</form>
```

AJAX Filtro (Optional, para UX melhor):
```javascript
function applyFilter() {
    const params = new URLSearchParams({
        cdprojeto: document.querySelector('[name="cdprojeto"]').value,
        cdlocal: document.querySelector('[name="cdlocal"]').value,
        situacao: document.querySelector('[name="situacao"]').value,
    });
    window.location = `{{ route('patrimonios.index') }}?${params}`;
}
```

NUNCA:
â”œâ”€ localStorage para filtro
â”œâ”€ Session state
â”œâ”€ JavaScript state machine
â”œâ”€ Cookies
â””â”€ URL hash (#)

SEMPRE:
â”œâ”€ Query string (?param=value)
â”œâ”€ .withQueryString() em pagination
â”œâ”€ request('param') no controller
â””â”€ value="{{ request('param') }}" no input

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#4: CATÃLOGO DE COMPONENTES (Contrato de disponibilidade)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Todos BLADE COMPONENTS em resources/views/components/:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ action-button.blade.php                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ @props(['href', 'action', 'label', 'confirm' => false])         â”‚
â”‚ @props(['method' => 'GET', 'data' => []])                       â”‚
â”‚                                                                 â”‚
â”‚ <a :href="href" class="...">                                   â”‚
â”‚   @if (action === 'edit') âœï¸ @endif                             â”‚
â”‚   @if (action === 'delete') ğŸ—‘ï¸ @endif                          â”‚
â”‚   @if (action === 'view') ğŸ‘ï¸ @endif                            â”‚
â”‚   {{ label ?? ucfirst(action) }}                                â”‚
â”‚ </a>                                                           â”‚
â”‚                                                                 â”‚
â”‚ USO:                                                            â”‚
â”‚ <x-action-button :href="route('patrimonios.edit', $p)" action="edit" />
â”‚ <x-action-button :href="route('patrimonios.destroy', $p)"      â”‚
â”‚   action="delete" confirm="true" />                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ status-badge.blade.php                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ @props(['status', 'size' => 'sm'])                              â”‚
â”‚                                                                 â”‚
â”‚ <span class="px-2 py-1 rounded text-xs font-medium"            â”‚
â”‚   :class="statusColor(status)">                                â”‚
â”‚   {{ status }}                                                 â”‚
â”‚ </span>                                                        â”‚
â”‚                                                                 â”‚
â”‚ Cores automÃ¡ticas:                                             â”‚
â”‚ Ativo â†’ green-100 / green-800                                  â”‚
â”‚ Inativo â†’ gray-100 / gray-800                                  â”‚
â”‚ Baixado â†’ red-100 / red-800                                    â”‚
â”‚ Pendente â†’ amber-100 / amber-800                               â”‚
â”‚                                                                 â”‚
â”‚ USO:                                                            â”‚
â”‚ <x-status-badge status="Ativo" />                              â”‚
â”‚ <x-status-badge :status="$patrimonio->SITUACAO" />             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ table-header.blade.php                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ @props(['label', 'sortable' => true, 'sortField'])              â”‚
â”‚ @props(['currentSort' => '', 'currentDirection' => 'asc'])      â”‚
â”‚                                                                 â”‚
â”‚ <th>                                                           â”‚
â”‚   @if (sortable)                                               â”‚
â”‚     <a href="?sort={{ sortField }}&direction=...">             â”‚
â”‚       {{ label }}                                              â”‚
â”‚       @if ($currentSort === $sortField)                        â”‚
â”‚         {{ $currentDirection === 'asc' ? 'â†‘' : 'â†“' }}           â”‚
â”‚       @endif                                                   â”‚
â”‚     </a>                                                       â”‚
â”‚   @else                                                        â”‚
â”‚     {{ label }}                                                â”‚
â”‚   @endif                                                       â”‚
â”‚ </th>                                                          â”‚
â”‚                                                                 â”‚
â”‚ USO:                                                            â”‚
â”‚ <x-table-header label="PatrimÃ´nio" sortField="NUPATRIMONIO"    â”‚
â”‚   :currentSort="request('sort')" :currentDirection="request('direction')" />
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pagination.blade.php (Laravel padrÃ£o)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ {{ $items->withQueryString()->links() }}                        â”‚
â”‚                                                                 â”‚
â”‚ SEMPRE usa .withQueryString() para manter filtros              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

RESTRIÃ‡ÃƒO:
â”œâ”€ NÃƒO criar novo componente se existe similar
â”œâ”€ NÃƒO duplicar componente com variaÃ§Ã£o menor
â”œâ”€ SE precisa variaÃ§Ã£o, estender o existente (@props)
â””â”€ Listar acima ANTES de criar novo

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#5: ASSINATURAS DE SERVICE (Contrato de mÃ©todos)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

TODO Service segue padrÃ£o rÃ­gido:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PatrimonioService (Template padrÃ£o)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ class PatrimonioService {                                       â”‚
â”‚                                                                 â”‚
â”‚   // LEITURA                                                    â”‚
â”‚   public function listar(Request $req): Collection;             â”‚
â”‚   public function buscarPorId(int $id): Model;                  â”‚
â”‚   public function pesquisar(string $termo): Collection;         â”‚
â”‚   public function estatisticas(): array;                        â”‚
â”‚                                                                 â”‚
â”‚   // ESCRITA                                                    â”‚
â”‚   public function criar(array $dados): Model;                   â”‚
â”‚   public function atualizar(int $id, array $dados): Model;      â”‚
â”‚   public function deletar(int $id): bool;                       â”‚
â”‚                                                                 â”‚
â”‚   // OPERAÃ‡Ã•ES ESPECIAIS                                        â”‚
â”‚   public function importar(File $arquivo): array;               â”‚
â”‚   public function exportar(Collection $items): string;          â”‚
â”‚   public function aplicarEmMassa(array $ids, array $acao): array;
â”‚                                                                 â”‚
â”‚ }                                                              â”‚
â”‚                                                                 â”‚
â”‚ REGRAS:                                                         â”‚
â”‚ â”œâ”€ Retorno SEMPRE tipado (Model, Collection, array, bool)      â”‚
â”‚ â”œâ”€ ParÃ¢metros SEMPRE explÃ­citos (nÃ£o $request)                 â”‚
â”‚ â”œâ”€ Exception handling DENTRO service (try/catch)               â”‚
â”‚ â”œâ”€ Log SEMPRE com emoji + contexto                             â”‚
â”‚ â”œâ”€ DB::transaction() para operaÃ§Ãµes crÃ­ticas                   â”‚
â”‚ â””â”€ Nunca retorna response/redirect                             â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Exemplo CONCRETO (PatrimonioService.php):

```php
class PatrimonioService {

    /**
     * Listar patrimÃ´nios com filtros
     */
    public function listar(
        string $cdprojeto = null,
        string $cdlocal = null,
        string $situacao = null,
        int $page = 1,
        int $perPage = 30
    ): LengthAwarePaginator {
        Log::info('[PatrimonioService] listar iniciado', [
            'cdprojeto' => $cdprojeto,
            'page' => $page,
        ]);

        $query = Patrimonio::query()
            ->when($cdprojeto, fn($q) => $q->where('CDPROJETO', $cdprojeto))
            ->when($cdlocal, fn($q) => $q->where('CDLOCAL', $cdlocal))
            ->when($situacao, fn($q) => $q->where('SITUACAO', $situacao))
            ->orderBy('DTOPERACAO', 'desc');

        return $query->paginate($perPage, ['*'], 'page', $page);
    }

    /**
     * Buscar por ID
     */
    public function buscarPorId(int $id): Patrimonio {
        Log::info('[PatrimonioService] buscarPorId', ['id' => $id]);
        
        $patrimonio = Patrimonio::findOrFail($id);
        return $patrimonio;
    }

    /**
     * Criar novo patrimÃ´nio
     */
    public function criar(array $dados): Patrimonio {
        Log::info('[PatrimonioService] criar iniciado', ['nupatrimonio' => $dados['NUPATRIMONIO'] ?? null]);

        DB::beginTransaction();
        try {
            $patrimonio = Patrimonio::create($dados);
            
            // Registrar movimento
            MovPartr::create([
                'patrimonio_id' => $patrimonio->NUSEQPATR,
                'acao' => 'CRIACAO',
                'usuario' => Auth::user()->NMLOGIN,
            ]);

            DB::commit();
            Log::info('âœ… [PatrimonioService] criado', ['id' => $patrimonio->NUSEQPATR]);
            return $patrimonio;
            
        } catch (Exception $e) {
            DB::rollBack();
            Log::error('âŒ [PatrimonioService] erro ao criar', ['erro' => $e->getMessage()]);
            throw $e;
        }
    }

    /**
     * Atualizar patrimÃ´nio
     */
    public function atualizar(int $id, array $dados): Patrimonio {
        Log::info('[PatrimonioService] atualizar iniciado', ['id' => $id]);

        DB::beginTransaction();
        try {
            $patrimonio = Patrimonio::findOrFail($id);
            $original = $patrimonio->getOriginal(); // Valor antes
            
            $patrimonio->update($dados);
            
            // Registrar o que mudou
            MovPartr::create([
                'patrimonio_id' => $id,
                'acao' => 'ATUALIZACAO',
                'campo' => array_keys(array_diff($dados, $original)),
                'usuario' => Auth::user()->NMLOGIN,
            ]);

            DB::commit();
            Log::info('âœ… [PatrimonioService] atualizado', ['id' => $id]);
            return $patrimonio;
            
        } catch (Exception $e) {
            DB::rollBack();
            Log::error('âŒ [PatrimonioService] erro ao atualizar', ['erro' => $e->getMessage()]);
            throw $e;
        }
    }

    /**
     * Deletar patrimÃ´nio
     */
    public function deletar(int $id): bool {
        Log::info('[PatrimonioService] deletar iniciado', ['id' => $id]);

        DB::beginTransaction();
        try {
            $patrimonio = Patrimonio::findOrFail($id);
            
            // Backup antes de deletar
            MovPartr::create([
                'patrimonio_id' => $id,
                'acao' => 'DELECAO',
                'backup_json' => json_encode($patrimonio->toArray()),
                'usuario' => Auth::user()->NMLOGIN,
            ]);

            $patrimonio->delete();
            
            DB::commit();
            Log::info('âœ… [PatrimonioService] deletado', ['id' => $id]);
            return true;
            
        } catch (Exception $e) {
            DB::rollBack();
            Log::error('âŒ [PatrimonioService] erro ao deletar', ['erro' => $e->getMessage()]);
            throw $e;
        }
    }

    /**
     * Pesquisar por termo
     */
    public function pesquisar(string $termo): Collection {
        Log::info('[PatrimonioService] pesquisar', ['termo' => $termo]);
        
        return Patrimonio::where('NUPATRIMONIO', 'like', "%{$termo}%")
            ->orWhere('DEPATRIMONIO', 'like', "%{$termo}%")
            ->orderBy('DTOPERACAO', 'desc')
            ->get();
    }

    /**
     * OperaÃ§Ã£o em massa
     */
    public function aplicarEmMassa(array $ids, string $acao, array $dados = []): array {
        Log::info('[PatrimonioService] operaÃ§Ã£o em massa', [
            'acao' => $acao,
            'count' => count($ids),
        ]);

        DB::beginTransaction();
        try {
            $processados = 0;
            $erros = [];

            foreach ($ids as $id) {
                try {
                    $patrimonio = Patrimonio::findOrFail($id);
                    
                    if ($acao === 'atualizar_situacao') {
                        $this->atualizar($id, ['SITUACAO' => $dados['SITUACAO'] ?? 'Ativo']);
                    } elseif ($acao === 'deletar') {
                        $this->deletar($id);
                    }
                    
                    $processados++;
                } catch (Exception $e) {
                    $erros[] = ['id' => $id, 'erro' => $e->getMessage()];
                }
            }

            DB::commit();
            Log::info('âœ… [PatrimonioService] operaÃ§Ã£o em massa concluÃ­da', [
                'processados' => $processados,
                'erros' => count($erros),
            ]);

            return [
                'processados' => $processados,
                'erros' => $erros,
                'sucesso' => count($erros) === 0,
            ];
            
        } catch (Exception $e) {
            DB::rollBack();
            Log::error('âŒ [PatrimonioService] erro em massa', ['erro' => $e->getMessage()]);
            throw $e;
        }
    }
}
```

CONTRATO DE ASSINATURA (Todos services devem ter):
```
listar(filters...): Paginator
buscarPorId(id): Model
criar(dados): Model
atualizar(id, dados): Model
deletar(id): bool
pesquisar(termo): Collection
aplicarEmMassa(ids, acao, dados): array
```

Uso no CONTROLLER:
```php
class PatrimonioController {
    public function __construct(private PatrimonioService $service) {}

    public function index(Request $request): View {
        $patrimonios = $this->service->listar(
            $request->input('cdprojeto'),
            $request->input('cdlocal'),
            $request->input('situacao'),
        );
        return view('patrimonios.index', compact('patrimonios'));
    }

    public function store(StorePatrimonioRequest $request): RedirectResponse {
        try {
            $patrimonio = $this->service->criar($request->validated());
            return redirect()->route('patrimonios.show', $patrimonio)
                ->with('success', 'Criado!');
        } catch (Exception $e) {
            return back()->with('error', $e->getMessage());
        }
    }

    public function update(UpdatePatrimonioRequest $request, Patrimonio $patrimonio): RedirectResponse {
        try {
            $this->service->atualizar($patrimonio->NUSEQPATR, $request->validated());
            return back()->with('success', 'Atualizado!');
        } catch (Exception $e) {
            return back()->with('error', $e->getMessage());
        }
    }

    public function destroy(Patrimonio $patrimonio): RedirectResponse {
        try {
            $this->service->deletar($patrimonio->NUSEQPATR);
            return redirect()->route('patrimonios.index')
                ->with('success', 'Deletado!');
        } catch (Exception $e) {
            return back()->with('error', $e->getMessage());
        }
    }
}
```

================================================================================
PRONTO! Agora vocÃª tem CONTRATOS IRREVOGÃVEIS.

Codex nÃ£o vai questionar. NÃ£o vai "sugerir alternativa". Simplesmente segue.

Com esses 5 contratos + 2 documentos anteriores, o assistente trabalha 100%
autonomamente sem supervisÃ£o a cada mudanÃ§a.

Good luck! ğŸš€
================================================================================
